# FSM (–ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π) WhatsApp –ë–æ—Ç–∞ - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –û–±–∑–æ—Ä

WhatsApp –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FSM (Finite State Machine) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏. –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –∏–∑ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –ø–æ–Ω–∏–º–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

## –°–æ—Å—Ç–æ—è–Ω–∏—è FSM

–í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `utils/state.py`:

```python
class States:
    MAIN_MENU = "MAIN_MENU"           # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    SELECT_WORK = "SELECT_WORK"       # –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Ä–∞–±–æ—Ç—ã
    SELECT_SHIFT = "SELECT_SHIFT"     # –í—ã–±–æ—Ä —Å–º–µ–Ω—ã
    SELECT_HOURS = "SELECT_HOURS"     # –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Å–æ–≤
    CONFIRM_SAVE = "CONFIRM_SAVE"     # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
```

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—É—Ç—å

### 1Ô∏è‚É£ MAIN_MENU - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

**–¢—Ä–∏–≥–≥–µ—Ä:** –ö–æ–º–∞–Ω–¥—ã "start", "—Å—Ç–∞—Ä—Ç", "–º–µ–Ω—é", "/start"

**–î–µ–π—Å—Ç–≤–∏–µ:**
- –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 3 –∫–Ω–æ–ø–∫–∏:
  - üìã –†–∞–±–æ—Ç–∞
  - ‚è∞ –ò–Ω—Ñ–æ –æ —á–∞—Å–∞—Ö
  - ‚ùì –ü–æ–º–æ—â—å

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `States.MAIN_MENU`

**–ö–æ–¥:**
```python
def handle_main_menu(phone: str):
    set_state(phone, States.MAIN_MENU)
    buttons = [
        {"id": "work_menu", "title": "üìã –†–∞–±–æ—Ç–∞"},
        {"id": "hours_menu", "title": "‚è∞ –ò–Ω—Ñ–æ –æ —á–∞—Å–∞—Ö"},
        {"id": "help_menu", "title": "‚ùì –ü–æ–º–æ—â—å"}
    ]
    send_buttons(phone, text, buttons)
```

---

### 2Ô∏è‚É£ SELECT_WORK - –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Ä–∞–±–æ—Ç—ã

**–¢—Ä–∏–≥–≥–µ—Ä:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–†–∞–±–æ—Ç–∞" (id: `work_menu`)

**–î–µ–π—Å—Ç–≤–∏–µ:**
- –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ (list message) —Å 4 —Ç–∏–ø–∞–º–∏ —Ä–∞–±–æ—Ç:
  - üåæ –ü–æ–ª–µ
  - ü•í –ö–∞–±–∞—á–æ–∫
  - ü•î –ö–∞—Ä—Ç–æ—à–∫–∞
  - üì¶ –î—Ä—É–≥–æ–µ

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `States.SELECT_WORK`

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞:**
```python
# webhook.py
if current_state == States.SELECT_WORK:
    logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_WORK - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç—ã")
    # –ü–µ—Ä–µ–¥–∞—ë–º –≤ menu_handlers.handle_list_selection()

# menu_handlers.py
if current_state == States.SELECT_WORK:
    if list_id in WORK_TYPES:
        work_name = WORK_TYPES[list_id]
        update_user_data(phone, 'work', work_name)
        handle_select_shift(phone)  # ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ SELECT_SHIFT
```

**–°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- `work` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü–æ–ª–µ")
- `work_id` - ID –≤—ã–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "work_field")

---

### 3Ô∏è‚É£ SELECT_SHIFT - –í—ã–±–æ—Ä —Å–º–µ–Ω—ã

**–¢—Ä–∏–≥–≥–µ—Ä:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç—ã

**–î–µ–π—Å—Ç–≤–∏–µ:**
- –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Å 3 —Å–º–µ–Ω–∞–º–∏:
  - ‚òÄÔ∏è –°–º–µ–Ω–∞ 1 (8-16)
  - üåÜ –°–º–µ–Ω–∞ 2 (16-00)
  - üåô –°–º–µ–Ω–∞ 3 (00-8)

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `States.SELECT_SHIFT`

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞:**
```python
# webhook.py
if current_state == States.SELECT_SHIFT:
    logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_SHIFT - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω—ã")

# menu_handlers.py
if current_state == States.SELECT_SHIFT:
    if list_id in SHIFTS:
        shift_hours = SHIFTS[list_id]['hours']
        update_user_data(phone, 'shift', shift_hours)
        handle_select_hours(phone)  # ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ SELECT_HOURS
```

**–°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- `shift` - –≤—Ä–µ–º—è —Å–º–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "8-16")
- `shift_id` - ID –≤—ã–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "shift_1")

---

### 4Ô∏è‚É£ SELECT_HOURS - –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Å–æ–≤

**–¢—Ä–∏–≥–≥–µ—Ä:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω—ã

**–î–µ–π—Å—Ç–≤–∏–µ:**
- –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—É –∏ —Å–º–µ–Ω—É
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Å 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ —á–∞—Å–æ–≤:
  - 4 —á–∞—Å–∞
  - 6 —á–∞—Å–æ–≤
  - 8 —á–∞—Å–æ–≤
  - 12 —á–∞—Å–æ–≤

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `States.SELECT_HOURS`

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞:**
```python
# webhook.py
if current_state == States.SELECT_HOURS:
    logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_HOURS - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤")

# menu_handlers.py
if current_state == States.SELECT_HOURS:
    if list_id in HOURS_OPTIONS:
        hours = HOURS_OPTIONS[list_id]
        update_user_data(phone, 'hours', hours)
        handle_show_confirmation(phone)  # ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ CONFIRM_SAVE
```

**–°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- `hours` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "8")
- `hours_id` - ID –≤—ã–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "hours_8")

---

### 5Ô∏è‚É£ CONFIRM_SAVE - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

**–¢—Ä–∏–≥–≥–µ—Ä:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤

**–î–µ–π—Å—Ç–≤–∏–µ:**
- –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
  - –†–∞–±–æ—Ç–∞
  - –°–º–µ–Ω–∞
  - –ß–∞—Å–æ–≤
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 2 –∫–Ω–æ–ø–∫–∏:
  - ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
  - ‚ùå –û—Ç–º–µ–Ω–∞

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:** `States.CONFIRM_SAVE`

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:**
```python
# webhook.py
if current_state == States.CONFIRM_SAVE:
    logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ CONFIRM_SAVE - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")

# menu_handlers.py
def handle_confirm_save(phone: str, confirmed: bool):
    if confirmed:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        work = get_user_data(phone, 'work')
        shift = get_user_data(phone, 'shift')
        hours = get_user_data(phone, 'hours')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Google Sheets
        save_entry(phone, work, shift, hours)
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        clear_state(phone)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        handle_main_menu(phone)
    else:
        # –û—Ç–º–µ–Ω–∞ - –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        clear_state(phone)
        handle_main_menu(phone)
```

**–§–∏–Ω–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ:**
- –í—ã–∑–æ–≤ `utils.sheets.save_entry(phone, work, shift, hours)`
- –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
- –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ FSM

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   START     ‚îÇ
‚îÇ  (–∫–æ–º–∞–Ω–¥–∞)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         MAIN_MENU                   ‚îÇ
‚îÇ  –ö–Ω–æ–ø–∫–∏: –†–∞–±–æ—Ç–∞ | –ò–Ω—Ñ–æ | –ü–æ–º–æ—â—å     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ –ù–∞–∂–∞—Ç–∞ "–†–∞–±–æ—Ç–∞"
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       SELECT_WORK                   ‚îÇ
‚îÇ  –°–ø–∏—Å–æ–∫: –ü–æ–ª–µ | –ö–∞–±–∞—á–æ–∫ |           ‚îÇ
‚îÇ          –ö–∞—Ä—Ç–æ—à–∫–∞ | –î—Ä—É–≥–æ–µ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ –í—ã–±—Ä–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       SELECT_SHIFT                  ‚îÇ
‚îÇ  –°–ø–∏—Å–æ–∫: –°–º–µ–Ω–∞ 1 | –°–º–µ–Ω–∞ 2 |        ‚îÇ
‚îÇ          –°–º–µ–Ω–∞ 3                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ –í—ã–±—Ä–∞–Ω–∞ —Å–º–µ–Ω–∞
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       SELECT_HOURS                  ‚îÇ
‚îÇ  –°–ø–∏—Å–æ–∫: 4—á | 6—á | 8—á | 12—á        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ –í—ã–±—Ä–∞–Ω—ã —á–∞—Å—ã
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       CONFIRM_SAVE                  ‚îÇ
‚îÇ  –ö–Ω–æ–ø–∫–∏: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å | –û—Ç–º–µ–Ω–∞       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ           ‚îÇ
         ‚ñº           ‚ñº
   –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å   –û—Ç–º–µ–Ω–∞
         ‚îÇ           ‚îÇ
         ‚ñº           ‚îÇ
  save_entry()       ‚îÇ
         ‚îÇ           ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
      clear_state()
               ‚îÇ
               ‚ñº
        MAIN_MENU
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ webhook.py

–í `webhook.py` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —è–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM:

```python
# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
user_state = get_state(phone)
current_state = user_state.get('state')

logger.info(f"[MSG] –û—Ç {phone}, —Ç–∏–ø: {msg_type}, —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM: {current_state}")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
if msg_type == 'text':
    if current_state == States.SELECT_WORK:
        logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_WORK - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞")
    elif current_state == States.SELECT_SHIFT:
        logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_SHIFT - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞")
    # ... –∏ —Ç.–¥.
    
    handle_incoming_message(message)

elif msg_type == 'interactive':
    if interactive_type == 'list_reply':
        if current_state == States.SELECT_WORK:
            logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_WORK - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç—ã")
        elif current_state == States.SELECT_SHIFT:
            logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_SHIFT - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω—ã")
        elif current_state == States.SELECT_HOURS:
            logger.info(f"[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_HOURS - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤")
        
        handle_incoming_message(message)
```

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (utils/state.py)

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
from utils.state import set_state, States

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
set_state(phone, States.SELECT_WORK)

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏
set_state(phone, States.SELECT_SHIFT, {"work": "–ü–æ–ª–µ"})
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
from utils.state import get_state

# –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
user_state = get_state(phone)
current_state = user_state.get('state')  # "SELECT_WORK"
data = user_state.get('data')            # {"work": "–ü–æ–ª–µ"}
```

### –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
from utils.state import update_user_data, get_user_data

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
update_user_data(phone, 'work', '–ü–æ–ª–µ')
update_user_data(phone, 'shift', '8-16')
update_user_data(phone, 'hours', '8')

# –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
work = get_user_data(phone, 'work')           # "–ü–æ–ª–µ"
shift = get_user_data(phone, 'shift')         # "8-16"
hours = get_user_data(phone, 'hours', '0')    # "8" –∏–ª–∏ "0" –µ—Å–ª–∏ –Ω–µ—Ç
```

### –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```python
from utils.state import clear_state

# –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–±—Ä–æ—Å–∏—Ç—å –≤ None)
clear_state(phone)
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ö—Ä–∞–Ω–∏—Ç—Å—è:

```python
user_states = {
    "79991234567": {
        "state": "SELECT_HOURS",      # –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
        "data": {                      # –î–∞–Ω–Ω—ã–µ, —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
            "work": "–ü–æ–ª–µ",            # –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞
            "work_id": "work_field",   # ID —Ä–∞–±–æ—Ç—ã
            "shift": "8-16",           # –í—ã–±—Ä–∞–Ω–Ω–∞—è —Å–º–µ–Ω–∞
            "shift_id": "shift_1",     # ID —Å–º–µ–Ω—ã
            "hours": "8",              # –í—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Å—ã
            "hours_id": "hours_8"      # ID —á–∞—Å–æ–≤
        }
    }
}
```

---

## –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç "start"

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: start
–ë–æ—Ç: set_state(phone, MAIN_MENU)
–ë–æ—Ç: [–ö–Ω–æ–ø–∫–∏] –†–∞–±–æ—Ç–∞ | –ß–∞—Å—ã | –ü–æ–º–æ—â—å
```

### 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–†–∞–±–æ—Ç–∞"

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ö–Ω–æ–ø–∫–∞] work_menu
–ë–æ—Ç: set_state(phone, SELECT_WORK)
–ë–æ—Ç: [–°–ø–∏—Å–æ–∫] –ü–æ–ª–µ | –ö–∞–±–∞—á–æ–∫ | –ö–∞—Ä—Ç–æ—à–∫–∞ | –î—Ä—É–≥–æ–µ
```

### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–ü–æ–ª–µ"

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–°–ø–∏—Å–æ–∫] work_field
–ë–æ—Ç: update_user_data(phone, 'work', '–ü–æ–ª–µ')
–ë–æ—Ç: set_state(phone, SELECT_SHIFT)
–ë–æ—Ç: [–°–ø–∏—Å–æ–∫] –°–º–µ–Ω–∞ 1 | –°–º–µ–Ω–∞ 2 | –°–º–µ–Ω–∞ 3
```

### 4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–°–º–µ–Ω–∞ 1 (8-16)"

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–°–ø–∏—Å–æ–∫] shift_1
–ë–æ—Ç: update_user_data(phone, 'shift', '8-16')
–ë–æ—Ç: set_state(phone, SELECT_HOURS)
–ë–æ—Ç: [–°–ø–∏—Å–æ–∫] 4—á | 6—á | 8—á | 12—á
```

### 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "8 —á–∞—Å–æ–≤"

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–°–ø–∏—Å–æ–∫] hours_8
–ë–æ—Ç: update_user_data(phone, 'hours', '8')
–ë–æ—Ç: set_state(phone, CONFIRM_SAVE)
–ë–æ—Ç: –†–∞–±–æ—Ç–∞: –ü–æ–ª–µ
     –°–º–µ–Ω–∞: 8-16
     –ß–∞—Å–æ–≤: 8
     [–ö–Ω–æ–ø–∫–∏] –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å | –û—Ç–º–µ–Ω–∞
```

### 6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ö–Ω–æ–ø–∫–∞] confirm_yes
–ë–æ—Ç: save_entry(phone, '–ü–æ–ª–µ', '8-16', '8')
–ë–æ—Ç: clear_state(phone)
–ë–æ—Ç: set_state(phone, MAIN_MENU)
–ë–æ—Ç: ‚úÖ –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!
     [–ö–Ω–æ–ø–∫–∏] –†–∞–±–æ—Ç–∞ | –ß–∞—Å—ã | –ü–æ–º–æ—â—å
```

---

## –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

–≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∏–∑ **–ª—é–±–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è**:

| –ö–æ–º–∞–Ω–¥–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|----------|
| `start`, `—Å—Ç–∞—Ä—Ç`, `menu`, `/start` | –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç FSM) |
| `help`, `–ø–æ–º–æ—â—å`, `/help` | –°–ø—Ä–∞–≤–∫–∞ |
| `cancel`, `–æ—Ç–º–µ–Ω–∞`, `stop` | –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è |

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ FSM

–í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```
[FSM] 79991234567: MAIN_MENU
[FSM] 79991234567: SELECT_WORK
[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_WORK - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–∞–±–æ—Ç—ã
[FSM] 79991234567: –†–∞–±–æ—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞ - –ü–æ–ª–µ
[FSM] 79991234567: SELECT_SHIFT
[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_SHIFT - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–º–µ–Ω—ã
[FSM] 79991234567: –°–º–µ–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞ - –°–º–µ–Ω–∞ 1 (8-16)
[FSM] 79991234567: SELECT_HOURS
[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ SELECT_HOURS - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Å–æ–≤
[FSM] 79991234567: –ß–∞—Å—ã –≤—ã–±—Ä–∞–Ω—ã - 8
[FSM] 79991234567: CONFIRM_SAVE (–ø–æ–∫–∞–∑)
[FSM] –°–æ—Å—Ç–æ—è–Ω–∏–µ CONFIRM_SAVE - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
[FSM] 79991234567: CONFIRM_SAVE (–æ–±—Ä–∞–±–æ—Ç–∫–∞: –î–∞)
[SAVE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏: {'phone': '79991234567', 'work': '–ü–æ–ª–µ', 'shift': '8-16', 'hours': '8'}
```

---

## –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (utils/sheets.py)

–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `save_entry()`:

```python
def save_entry(phone: str, work: str, shift: str, hours: str) -> bool:
    """
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å –æ —Ä–∞–±–æ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Google Sheets.
    """
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    entry_data = {
        "timestamp": timestamp,
        "phone": phone,
        "work": work,
        "shift": shift,
        "hours": hours
    }
    
    # TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets API
    logger.info(f"üìù [SAVE] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏: {entry_data}")
    
    return True
```

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –î–∞–Ω–Ω—ã–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Google Sheets (–∑–∞–≥–ª—É—à–∫–∞).

**–ë—É–¥—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets API –¥–ª—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ FSM

‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ** - –±–æ—Ç –∑–Ω–∞–µ—Ç, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

‚úÖ **–£–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø–æ—Ç–æ–∫** - —Å—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤

‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –≤—Å–µ –≤—ã–±–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏

‚úÖ **–û—Ç–ª–∞–¥–∫–∞** - –ª–µ–≥–∫–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ª–æ–≥–∏

‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

‚úÖ **–û—Ç–º–µ–Ω–∞** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç

---

## –§–∞–π–ª—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `utils/state.py` | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM, —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
| `menu_handlers.py` | –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM |
| `webhook.py` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —É—á—ë—Ç–æ–º FSM |
| `utils/sheets.py` | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Ñ—É–Ω–∫—Ü–∏—è `save_entry()`) |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FSM

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏ FSM:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: `python bot.py`
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ "start" –≤ WhatsApp
3. –ù–∞–∂–º–∏—Ç–µ "–†–∞–±–æ—Ç–∞"
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞–±–æ—Ç—ã –∏–∑ —Å–ø–∏—Å–∫–∞
5. –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É –∏–∑ —Å–ø–∏—Å–∫–∞
6. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞
7. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
8. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f bot.log`

–í—ã —É–≤–∏–¥–∏—Ç–µ –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã FSM –≤ –ª–æ–≥–∞—Ö.

---

**–ì–æ—Ç–æ–≤–æ! FSM –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.** üöÄ

